version: '3.8'

services:
  # ============================================
  # MQTT Broker - Mosquitto
  # ============================================
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: campus-mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"   # MQTT
      - "9001:9001"   # WebSocket
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - campus-network

  # ============================================
  # Database - PostgreSQL + TimescaleDB
  # ============================================
  postgres:
    image: timescale/timescaledb:latest-pg15
    container_name: campus-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-campus}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-campus_secret}
      POSTGRES_DB: ${POSTGRES_DB:-campus_iot}
    ports:
      - "5432:5432"
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - campus-network

  # ============================================
  # Backend - FastAPI
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: campus-backend
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-campus}:${POSTGRES_PASSWORD:-campus_secret}@postgres:5432/${POSTGRES_DB:-campus_iot}
      MQTT_BROKER: mosquitto
      MQTT_PORT: 1883
      SECRET_KEY: ${SECRET_KEY:-super_secret_key_change_me}
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - mosquitto
    volumes:
      - ./backend/app:/app
    networks:
      - campus-network

  # ============================================
  # Node-RED - Automations
  # ============================================
  nodered:
    image: nodered/node-red:latest
    container_name: campus-nodered
    restart: unless-stopped
    ports:
      - "1880:1880"
    volumes:
      - ./nodered/data:/data
    environment:
      TZ: Europe/Paris
    depends_on:
      - mosquitto
    networks:
      - campus-network

  # ============================================
  # Frontend - Vue 3 + Vuetify (via Nginx)
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: campus-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - campus-network

networks:
  campus-network:
    driver: bridge
