version: '3.8'

services:
  # ============================================
  # MQTT Broker - Mosquitto
  # ============================================
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: campus-mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"   # MQTT
      - "9001:9001"   # WebSocket
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - campus-network

  # ============================================
  # Backend - FastAPI
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: campus-backend
    restart: unless-stopped
    environment:
      # Supabase Database (Session pooler)
      DATABASE_URL: postgresql://postgres.byseujemkgwqlxtkstge:IOTCESI2026@aws-1-eu-central-1.pooler.supabase.com:5432/postgres
      MQTT_BROKER: mosquitto
      MQTT_PORT: 1883
      SECRET_KEY: ${SECRET_KEY:-campus-iot-secret-key-2024}
    ports:
      - "8000:8000"
    depends_on:
      - mosquitto
    volumes:
      - ./backend/app:/app
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "aws-1-eu-central-1.pooler.supabase.com:3.71.225.44"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    networks:
      - campus-network

  # ============================================
  # Frontend - Vue 3 + Vuetify (via Nginx)
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: campus-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - campus-network

networks:
  campus-network:
    driver: bridge
