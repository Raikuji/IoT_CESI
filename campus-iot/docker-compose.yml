version: '3.8'

services:
  # ============================================
  # MQTT Broker - Mosquitto
  # ============================================
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: campus-mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"   # MQTT
      - "8883:8883"   # TLS Port
      - "9001:9001"   # WebSocket
    volumes:
      - ./mosquitto/certs:/mosquitto/certs
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - campus-network

  # ============================================
  # Backend - FastAPI
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: campus-backend
    restart: unless-stopped
    environment:
      # Supabase Database (Transaction pooler - mode pooling avec timeout augment√©)
      DATABASE_URL: postgresql://postgres.byseujemkgwqlxtkstge:IOTCESI2026@aws-1-eu-central-1.pooler.supabase.com:6543/postgres?options=-c%20statement_timeout%3D30000
      MQTT_BROKER: mosquitto
      MQTT_PORT: 1883
      SECRET_KEY: ${SECRET_KEY:-campus-iot-secret-key-2024}
      BACKUPS_ENABLED: "true"
      BACKUP_INTERVAL_MINUTES: "1440"
      BACKUP_RETENTION_DAYS: "7"
      BACKUP_DIR: "/app/backups"
      EXPORTS_ENABLED: "true"
      EXPORT_CHECK_INTERVAL_SECONDS: "60"
      EXPORT_DIR: "/app/exports"
    ports:
      - "8000:8000"
    depends_on:
      - mosquitto
    volumes:
      - ./backend/app:/app
      - ./backups:/app/backups
      - ./exports:/app/exports
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "aws-1-eu-central-1.pooler.supabase.com:3.71.225.44"
      - "discord.com:162.159.136.232"
      - "discordapp.com:162.159.136.232"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    networks:
      - campus-network

  # ============================================
  # Frontend - Vue 3 + Vuetify (via Nginx)
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: campus-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - campus-network

networks:
  campus-network:
    driver: bridge
