@startuml Campus_IoT_Architecture
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

title Campus IoT - CESI Nancy\nArchitecture complète de la chaîne IoT

' Définir les couleurs
!define LEGEND_BG #E8F4F8
!define SENSOR_COLOR #FFB6C1
!define NETWORK_COLOR #87CEEB
!define SERVER_COLOR #90EE90
!define DB_COLOR #DDA0DD
!define CLIENT_COLOR #F0E68C

package "CAPTEURS IOT\n(Bâtiment Orion)" <<frame>> {
    card Sensor1 [
        **BME280**
        ----
        Température
        Humidité
        Pression
    ] #SENSOR_COLOR
    
    card Sensor2 [
        **HC-SR04**
        ----
        Distance
        Présence
    ] #SENSOR_COLOR
    
    card Sensor3 [
        **Potentiomètre**
        ----
        Luminosité (ADC)
    ] #SENSOR_COLOR
    
    card Sensor4 [
        **MQ-135**
        ----
        CO2
    ] #SENSOR_COLOR
}

package "GATEWAY LOCAL\n(Collecteur)" <<frame>> {
    card Arduino [
        **Arduino Mega 2560**
        ----
        I2C: BME280
        GPIO: HC-SR04
        ADC: Potentiomètre
        Serial OUT: 9600 baud
    ] #SERVER_COLOR
    
    card XBeeCoord [
        **XBee Coordinator**
        ----
        ZigBee Mesh
        PAN ID: 1234
        Channel: 15
    ] #NETWORK_COLOR
    
    card Actuator1 [
        **Moteur DC**
        ----
        PWM Pin 5
        Relay driver
    ] #SERVER_COLOR
    
    card Actuator2 [
        **Speaker**
        ----
        PWM Pin 6
        Audio driver
    ] #SERVER_COLOR
}

package "CAPTEURS DISTANTS\n(XBee End Devices)" <<frame>> {
    card XBeeEND1 [
        **XBee End Device #1**
        ----
        Capteur BME280
        Routeur local
    ] #NETWORK_COLOR
    
    card XBeeEND2 [
        **XBee End Device #2**
        ----
        Capteur HC-SR04
        Routeur local
    ] #NETWORK_COLOR
}

package "GATEWAY APPLICATION\n(PC/Serveur)" <<frame>> {
    card Bridge [
        **mqtt_bridge.py**
        ----
        Lit port série Arduino
        Parse JSON
        Publie MQTT
        Reçoit commandes
    ] #SERVER_COLOR
}

package "BROKER MQTT\n(Mosquitto)" <<frame>> {
    card MQTTBroker [
        **Mosquitto Broker**
        ----
        Port 1883: MQTT TCP
        Port 9001: WebSocket
        Topics: campus/orion/*
        QoS: 0/1/2
    ] #NETWORK_COLOR
}

package "BACKEND\n(FastAPI)" <<frame>> {
    card API [
        **FastAPI Server**
        ----
        REST Endpoints
        WebSocket Server
        MQTT Client
        JWT Auth
    ] #SERVER_COLOR
    
    card Services [
        **Services**
        ----
        Sensor Manager
        Alert Manager
        Energy Manager
        Security Service
    ] #SERVER_COLOR
}

package "DATABASE\n(Supabase Cloud)" <<frame>> {
    card DB [
        **PostgreSQL**
        + **TimescaleDB**
        ----
        Sensors data
        Alerts history
        Users & logs
        Energy profiles
    ] #DB_COLOR
}

package "FRONTEND\n(Client Web)" <<frame>> {
    card WebUI [
        **Vue 3 + Vuetify**
        ----
        Dashboard
        Alerts view
        Admin panel
        Real-time charts
    ] #CLIENT_COLOR
}

' Relations Capteurs -> Gateway
Sensor1 -.I2C.-> Arduino : "I2C\n(SDA/SCL)"
Sensor2 -.GPIO.-> Arduino : "GPIO\n(TRIG/ECHO)"
Sensor3 -.ADC.-> Arduino : "Analog\n(A0)"
Sensor4 -.I2C.-> Arduino : "I2C"

' Relations Actionneurs <- Gateway
Arduino -.PWM.-> Actuator1 : "PWM Pin 5"
Arduino -.PWM.-> Actuator2 : "PWM Pin 6"

' Relations XBee
Arduino ---"ZigBee\nMesh"---> XBeeCoord
XBeeCoord ---"ZigBee (30m)"---> XBeeEND1
XBeeCoord ---"ZigBee (30m)"---> XBeeEND2

' Relations Serial
Arduino ===o"Serial 9600 baud"o=== Bridge : "USB"

' Relations MQTT
Bridge ---"MQTT TCP\nPort 1883"---> MQTTBroker
API ---"MQTT Client"---> MQTTBroker
MQTTBroker ---"Topics:\nsensors/*\nactuators/*"---> API

' Relations API <-> DB
API ===o"TCP 5432"o=== DB

' Relations Frontend <-> Backend
WebUI ---"HTTP REST\n/api/*"---> API
WebUI ---"WebSocket\n/ws"---> API
API ---"JSON Push\n(real-time)"---> WebUI

' Légende flux de données
legend right
    |<#FFE4E1> Capteurs locaux (Serial/I2C/GPIO) |
    |<#87CEEB> Communication (ZigBee, MQTT, TCP) |
    |<#90EE90> Traitement (Gateway, Services) |
    |<#DDA0DD> Persistance (Database) |
    |<#F0E68C> Présentation (Frontend) |
endlegend

note bottom of Sensor1
  **Format capteur local:**
  Mesure continue
  Envoi à Arduino
  Sérialisé en JSON
end note

note bottom of XBeeCoord
  **ZigBee Mesh:**
  - Portée ~30m indoor
  - Auto-healing
  - Jusqu'à 65k nœuds
  - Débit 250 kbps
end note

note bottom of MQTTBroker
  **Topics:**
  campus/orion/sensors/temperature
  campus/orion/sensors/humidity
  campus/orion/actuators/motor
  campus/orion/controls/energy/{id}
end note

note bottom of API
  **Latence estimée:**
  XBee: 50ms
  MQTT: 100ms
  WebSocket: 50ms
  UI Render: 800ms
  **Total: <2s**
end note

@enduml
